# Generated from:
# https://github.com/plone/meta/tree/master/config/default
[tox]
# We need 4.4.0 for constrain_package_deps.
min_version = 4.4.0
envlist =
    format
    lint
    test
    py{37,38,39}-plone{52}
    py{38,39}-plone{60}
    # towncrier
#    coverage-report
    linkcheck
    plone6docs
    docs
skip_missing_interpreters = True

[testenv]
allowlist_externals =
    sh
skip_install = True

[testenv:format]
description = automatically reformat code
skip_install = true
deps =
    pre-commit
commands =
    pre-commit run -a pyupgrade
    pre-commit run -a isort
    pre-commit run -a black
    pre-commit run -a zpretty

[testenv:lint]
description = run linters that will help improve the code style
skip_install = true
deps =
    pre-commit
commands =
    pre-commit run -a

[testenv:dependencies]
description = check if the package defines all its dependencies
skip_install = true
deps =
    build
    z3c.dependencychecker==2.11
commands =
    python -m build --sdist --no-isolation
    dependencychecker

[testenv:dependencies-graph]
description = generate a graph out of the package's dependencies
deps =
    pipdeptree==2.5.1
    graphviz  # optional dependency of pipdeptree
commands =
    sh -c 'pipdeptree --exclude setuptools,wheel,pipdeptree,zope.interface,zope.component --graph-output svg > dependencies.svg'

[testenv:test]
use_develop = true
constrain_package_deps = true
set_env = ROBOT_BROWSER=headlesschrome
deps =
    zope.testrunner
    -c https://dist.plone.org/release/6.0-dev/constraints.txt
commands =
    zope-testrunner --all --test-path={toxinidir}/src -s plone.api {posargs}
extras =
    test

[testenv:coverage]
use_develop = true
constrain_package_deps = true
set_env = ROBOT_BROWSER=headlesschrome
deps =
    coverage
    zope.testrunner
    -c https://dist.plone.org/release/6.0-dev/constraints.txt
commands =
    coverage run {envbindir}/zope-testrunner --quiet --all --test-path={toxinidir}/src -s plone.api {posargs}
    coverage report -m --format markdown
extras =
    test
[gh-actions]
python =
    3.7: py37
    3.8: py38
    3.9: py39

[gh-actions:env]
PLONE =
    52: plone52
    60: plone60

commands =
    python -VV
    pip install -r requirements.txt
    pip list
    {envbindir}/buildout -c /{toxinidir}/{env:BUILDOUT_FILE} buildout:directory={envdir} buildout:develop={toxinidir} install test
    {envbindir}/buildout -c {toxinidir}/{env:BUILDOUT_FILE} buildout:directory={envdir} buildout:develop={toxinidir} annotate
    {envbindir}/test

setenv =
    BUILDOUT_FILE=test_plone-60.cfg
    plone52: BUILDOUT_FILE=test_plone-52.cfg

deps =
    pdbpp
    manuel

# tox < 4.0.0
whitelist_externals =
    mkdir
    echo

# tox >= 4.0.0
allowlist_externals =
    mkdir
    echo

[testenv:coverage-report]
basepython = python3.9
deps = coverage

setenv =
    COVERAGE_FILE=.coverage

skip_install = True

commands =
    python -VV
    coverage erase
    coverage combine
    coverage report
    coverage html
    coverage xml

[testenv:plone6docs]
# New docs with sphinx-book-theme
# See [testenv:docs] for classic documentation
basepython = python3.9
skip_install = False
usedevelop = True
extras =
    tests

deps =
    -r requirements-docs.txt

commands =
    python -VV
    mkdir -p {toxinidir}/_build/plone6docs
    sphinx-build -b html -d _build/plone6docs/doctrees docs _build/plone6docs/html


[testenv:docs]
basepython = python3.9
skip_install = False
usedevelop = True
extras =
    tests

deps =
    -r requirements-docs.txt

commands =
    python -VV
    mkdir -p {toxinidir}/_build/docs
    sphinx-build -b html -D html_theme=alabaster -d _build/docs/doctrees docs _build/docs/html

whitelist_externals =
    mkdir


[testenv:linkcheck]
basepython = python
skip_install = False
usedevelop = True
extras =
    {[testenv:plone6docs]extras}
deps =
    {[testenv:plone6docs]deps}
commands =
    python -VV
    mkdir -p {toxinidir}/_build/plone6docs
    sphinx-build -b linkcheck -d _build/plone6docs/doctrees docs _build/plone6docs/linkcheck


[testenv:towncrier]
basepython = python
skip_install = True

deps=
    towncrier

commands =
    towncrier --draft
